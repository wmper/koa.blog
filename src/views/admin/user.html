<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>用户管理</title>
        <link rel="stylesheet" href="/css/common.css" />
        <link rel="stylesheet" href="/css/element.css" />
        <script src="/js/vue.js"></script>
        <script src="/js/element.js"></script>
        <script src="/js/axios.min.js"></script>
        <script src="/js/crypto-js.js"></script>
    </head>
    <body>
        <div id="app">
            <template>
                <div style="margin-bottom: 15px">
                    <el-button type="primary" plain size="small" @click="handleClick()">新增</el-button>
                    <el-button size="small" icon="el-icon-refresh-left" @click="load(0)">刷新</el-button>
                </div>
                <el-table :data="tableData" stripe style="width: 100%; font-size: 13px">
                    <el-table-column type="index" label="序号" width="80"> </el-table-column>
                    <el-table-column prop="username" label="用户名" width="180"></el-table-column>
                    <el-table-column prop="create_time" label="日期"></el-table-column>
                    <el-table-column fixed="right" label="操作" width="180">
                        <template slot-scope="scope">
                            <el-button @click="handleClick(scope.row)" type="text" size="small">编辑</el-button>
                            <el-button @click="handleDelete(scope.row.id,scope.$index)" type="text" size="small" style="color: #ff0000">删除</el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <div style="display: flex; flex-direction: row-reverse; margin-top: 30px">
                    <el-pagination @current-change="handleCurrentChange" :current-page.sync="current" :page-size="size" :total="total" background layout="total,prev, pager, next, jumper"> </el-pagination>
                </div>
                <el-dialog :title="title" :visible.sync="dialogVisible" :show-close="false" :close-on-click-modal="false" width="35%">
                    <el-form label-position="right" label-width="80px" :model="form">
                        <el-form-item label="id" hidden>
                            <el-input v-model="form.id"></el-input>
                        </el-form-item>
                        <el-form-item label="用户名">
                            <el-input v-model="form.username"></el-input>
                        </el-form-item>
                        <el-form-item label="密码">
                            <el-input v-model="form.password" type="password"></el-input>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="handleOk()">确 定</el-button>
                    </span>
                </el-dialog>
            </template>
        </div>
        <script>
            axios.defaults.headers.common['Authorization'] = 'Bearer ' + window.localStorage.getItem('token')
            new Vue({
                el: '#app',
                data: {
                    title: '新增',
                    dialogVisible: false,
                    current: 1,
                    size: 20,
                    total: 0,
                    tableData: [],
                    form: {
                        id: 0,
                        username: null,
                        password: null
                    }
                },
                methods: {
                    load(type) {
                        let _this = this
                        if (type == 0) _this.current = 1

                        axios.post('/api/user/list', { pageIndex: _this.current, pageSize: _this.size }).then((res) => {
                            if (res.status == 200) {
                                _this.tableData = res.data.data.list
                                _this.total = res.data.data.total

                                if (type == 0) _this.$message.success('刷新成功')
                            }
                        })
                    },
                    handleClick(e) {
                        if (e) {
                            this.title = '编辑'
                            this.form = JSON.parse(JSON.stringify(e))
                            this.form.password = null
                        } else {
                            this.title = '新增'
                            this.form = {
                                id: 0,
                                username: null,
                                password: null
                            }
                        }
                        this.dialogVisible = true
                    },
                    handleOk() {
                        let _this = this
                        if (!_this.form.username) return

                        let data = { id: _this.form.id, username: _this.form.username }
                        if (_this.form.password) {
                            data.password = CryptoJS.MD5(_this.form.password).toString()
                        }

                        axios.post('/api/user/save', data).then((res) => {
                            if (res.data.code != 0) {
                                _this.$message.warning(res.data.msg)
                                return
                            }

                            _this.$message.success(res.data.msg)
                            _this.load()
                            _this.dialogVisible = false
                        })
                    },
                    handleDelete(id, index) {
                        let _this = this

                        this.$confirm('确认删除?', '提示', {
                            type: 'warning'
                        }).then(() => {
                            axios.delete('/api/user/' + id).then((res) => {
                                if (res.data.code == 0) {
                                    _this.$message.success('删除成功')
                                    _this.tableData.splice(index, 1)
                                }
                            })
                        })
                    },
                    handleCurrentChange(val) {
                        this.current = val
                        this.load()
                    }
                },
                mounted() {
                    this.load()
                }
            })
        </script>
    </body>
</html>
